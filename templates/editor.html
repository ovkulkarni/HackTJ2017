{% extends "base-nav.html" %}

{% block css %}
    {{ super() }}
    <style>
    body {
        overflow: hidden;
        background-color: #434343;
        background-image:linear-gradient(#434343, #282828);
    }
    #content {
        background-image: linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .05) 25%, rgba(255, 255, 255, .05) 26%, transparent 27%, transparent 74%, rgba(255, 255, 255, .05) 75%, rgba(255, 255, 255, .05) 76%, transparent 77%, transparent);
        background-size: 50px 50px;
    }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
{% endblock %}

{% block js %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.9/fabric.min.js" integrity="sha256-D5qjlhHft5LNta9Zzei8iPWEAGyIQt6JkWftlBA81yk=" crossorigin="anonymous"></script>
    <script>
    var canvas;
    var blockSize = 100;

    function addBlock(name, type) {
        var rect = new fabric.Rect({
            fill: (function() {
                switch(type) {
                    case 'conditional':
                        return 'orange';
                    case 'trigger':
                        return 'red';
                    case 'event':
                        return 'blue';
                }
                return 'green';
            })(),
            width: blockSize,
            height: blockSize
        });
        rect.stroke = "#1565C0";
        rect.strokeWidth = 1;
        var text = new fabric.Text(name, {
            left: blockSize / 2,
            top: blockSize / 2,
            fontSize: 16,
            textAlign: "center",
            originX: "center",
            originY: "center",
            fontFamily: "sans-serif"
        });
        var block = new fabric.Group([rect, text], {
            left: $(window).width() / 2 - blockSize / 2,
            top: $(window).height() / 2 - blockSize / 2 - $("nav").height(),
            lockRotation: true,
            lockScalingX: true,
            lockScalingY: true,
            lockUniScaling: true
        });
        block.type = "block";
        block.connections = [];
        block.setControlsVisibility({"mtr": false});
        canvas.add(block);
        return block;
    }

    function connectBlocks(a, b) {
        var line = new fabric.Line([0, 0, 1, 1], {
            stroke: "red",
            strokeWidth: 2,
            selectable: false,
            originX: "left",
            originY: "top"
        });
        line.type = "line";
        var triangle = new fabric.Triangle({
            angle: 0,
            fill: "red",
            top: 0,
            left: 0,
            height: 25,
            width: 25,
            originX: "center",
            originY: "center",
            selectable: false
        });
        line.triangle = triangle;
        line.from = a;
        line.to = b;
        a.connections.push(line);
        b.connections.push(line);
        recalculateConnection(line);
        canvas.add(line);
        canvas.add(triangle);
    }

    function recalculateConnection(v) {
        var angle = Math.atan2(v.from.top - v.to.top, v.to.left - v.from.left)*180/Math.PI;
        console.log(angle);
        var fPos = "bottom";
        var tPos = "top";
        if (angle >= -45 && angle <= 45) {
            fPos = "right";
            tPos = "left";
        }
        else if (angle > 0 && angle <= 135) {
            fPos = "top";
            tPos = "bottom";
        }
        else if (Math.abs(angle) > 135) {
            fPos = "left";
            tPos = "right";
        }
        v.left = v.from.left + v.from.width / 2;
        v.top = v.from.top + v.from.height / 2;
        v.width = (v.to.left + v.to.width / 2) - v.left;
        v.set("flipX", v.width < 0);
        if (fPos == "left") {
            v.left += blockSize / 2;
        }
        if (fPos == "right") {
            v.left += blockSize / 2;
        }
        if (fPos == "top") {
            v.top -= blockSize / 2;
        }
        if (fPos == "bottom") {
            v.top += blockSize / 2;
        }
        v.triangle.left = v.left + v.width;
        if (tPos == "left") {
            v.triangle.left -= blockSize;
        }
        if (v.width < 0) {
            v.left += v.width;
        }
        v.width = Math.abs(v.width);
        v.height = (v.to.top + v.to.height / 2) - v.top;
        v.set("flipY", v.height < 0);
        if (tPos == "left") {
            v.width -= blockSize;
        }
        if (tPos == "right") {
            v.width -= blockSize;
        }
        if (tPos == "top") {
            v.height -= blockSize / 2;
        }
        if (tPos == "bottom") {
            v.height += blockSize / 2;
        }
        v.triangle.top = v.top + v.height;
        if (v.height < 0) {
            v.top += v.height;
        }
        v.height = Math.abs(v.height);
        v.triangle.angle = 90 - angle;
    }

    $(document).ready(function() {
        canvas = new fabric.Canvas("editor", { preserveObjectStacking: true });
        canvas.on("object:moving", function(e) {
            if (e.target.type == "block") {
                $.each(e.target.connections, function(k, v) {
                    recalculateConnection(v);
                });
            }
        });
        canvas.on("object:removed", function(e) {
            if (e.target.type == "block") {
                $.each(e.target.connections, function(k, v) {
                    canvas.remove(v);
                    v.from.connections.splice(v.from.connections.indexOf(v), 1);
                    v.to.connections.splice(v.to.connections.indexOf(v), 1);
                });
            }
        });
        var a = addBlock("block 1");
        var b = addBlock("block 2");
        connectBlocks(a, b);
        $(window).on("resize", function() {
            var width = window.innerWidth;
            var height = window.innerHeight - $("nav").height();
            $("#content").css("width", width + "px").css("height", height + "px");
            canvas.setWidth(width);
            canvas.setHeight(height);
        });
        $(window).on("keydown", function(e) {
            if (e.keyCode == 46) {
                canvas.remove(canvas.getActiveObject());
            }
        });
        $(window).resize();
        $("#triggers div").each(function(i,el) {
            el.onclick = function() {
                addBlock(el.innerHTML, "trigger");
            };
        });
        $("#events div").each(function(i,el) {
            el.onclick = function() {
                addBlock(el.innerHTML, "event");
            };
        });
        $("#conditionals div").each(function(i,el) {
            el.onclick = function() {
                addBlock(el.innerHTML, "conditional");
            };
        });
    });
    </script>
{% endblock %}

{% block content %}
    <div id="picker">
        <div id="picker-list">
            <h3>Triggers</h3>
            <div id="triggers">
                <div class="buy">Buy</div>
                <div class="time">Time</div>
                <div class="where">Where</div>
            </div>
            <h3>Events</h3>
            <div id="events">
                <div class="call">Call</div>
                <div class="text">Text</div>
            </div>
            <h3>Conditionals</h3>
            <div id="conditionals">
                <div class="while">While</div>
                <div class="if">If</div>
                <div class="else">Else</div>
            </div>
        </div>
        <div id="picker-arrow">
        </div>
    </div>
    <canvas id="editor"></canvas>
{% endblock %}
